# msi-calc

Microsatellite instability (MSI) analysis using [msisensor-pro](https://github.com/xjtu-omics/msisensor-pro),
with a full-screen TUI, parallel job execution, and resume support.

## Requirements

- **msisensor-pro** ≥ 2.0 (installed via bioconda or built from source)
- **Rust** ≥ 1.70 (for building from source; not needed when using Docker)
- A reference genome FASTA file (e.g., GRCh38)
- Indexed BAM files

---

## Quick Start: Docker (recommended)

### Build the image

```bash
docker build -t msi-calc .
```

### Run

```bash
docker run --rm \
  -v /host/reference:/data/ref:ro \
  -v /host/bams:/data/bams:ro \
  -v /host/results:/data/output \
  msi-calc \
    -r /data/ref/GRCh38.fa \
    -p /data/bams/sample_pairs.csv \
    -o /data/output
```

On first run, msi-calc automatically generates
`/data/output/microsatellites.list` using `msisensor-pro scan`.
Subsequent runs skip this step.

---

## Manual Install

### Option A: `setup.sh` (Linux / macOS)

```bash
git clone <repo-url>
cd msi-calc
chmod +x setup.sh
./setup.sh
```

The script will:
1. Install msisensor-pro (via conda/mamba or from source)
2. Install Rust via rustup if needed
3. Build msi-calc with `cargo build --release`

### Option B: Step-by-step

**Install msisensor-pro** (if conda is available):

```bash
conda install -c bioconda -c conda-forge msisensor-pro
```

**Or build from source:**

```bash
git clone https://github.com/xjtu-omics/msisensor-pro
cd msisensor-pro && mkdir build && cd build
cmake .. && make -j4
sudo cp ../msisensor-pro /usr/local/bin/
```

**Build msi-calc:**

```bash
cargo build --release
# binary: ./target/release/msi-calc
```

---

## Usage

```
msi-calc -r <FASTA> [OPTIONS]
```

### Options

```
-r, --reference <FASTA>   Reference genome (.fa or .fasta). REQUIRED.
-p, --pairs <FILE>        Sample pairs CSV [default: sample_pairs.csv]
-o, --output <DIR>        Output directory [default: msi-results]
-j, --jobs <N>            Parallel jobs [default: 16]
-t, --threads <N>         Threads per job [default: 2]
-h, --help                Print help
```

### Examples

```bash
# Basic run
msi-calc -r /data/GRCh38.fa -p sample_pairs.csv

# Custom paths
msi-calc -r /data/GRCh38.fa -p /data/pairs.csv -o /data/results

# 8 jobs × 4 threads = 32 cores
msi-calc -r /data/GRCh38.fa -p pairs.csv -j 8 -t 4

# Resume an interrupted run — same command, same output directory
msi-calc -r /data/GRCh38.fa -p pairs.csv -o /data/results
```

---

## Input Format

CSV with no header. Each row: `tumor_bam,normal_bam`
Leave the second column empty for tumor-only samples.

```
50T_CRC_final.bam,50N_CRC_final.bam   # paired
91T_CRC_final.bam,91N_CRC_final.bam   # paired
78T_CRC_final.bam,                    # tumor-only
19T_CRC_final.bam,                    # tumor-only
```

Sample names are derived by stripping `_final.bam`.

---

## Output Structure

```
<output>/
  microsatellites.list         Generated by scan step (cached)
  <sample>                     MSI result per sample
  <sample>_msisensor           Additional msisensor output
  logs/                        Per-step log files
    scan.log
    <sample>.log
    <sample>_profile.log
    baseline.log
  baseline/                    Only when tumor-only samples present
    baseline_config.txt
    baseline_model
    <normal>_all
  .checkpoints/                Resume state (hidden)
```

---

## Resume Behaviour

msi-calc is resume-aware at every phase:

- **Scan step**: skipped if `<output>/microsatellites.list` exists
- **Phase 1 (profiling)**: per-normal checkpoint in `.checkpoints/<name>_profile.done`
- **Phase 2 (baseline)**: skipped if `<output>/baseline/baseline_model` exists
- **Phase 3 (MSI)**: per-sample checkpoint in `.checkpoints/<name>.done`

Re-run the exact same command after any interruption to continue.

---

## Modes

| CSV contents | Mode | Phases |
|---|---|---|
| All paired samples | Paired-only | Phase 1/1: msisensor-pro msi |
| Mixed paired + tumor-only | Mixed | Phase 1/3: profile normals, 2/3: build baseline, 3/3: MSI |

Tumor-only-only is not supported (a paired sample is needed to build the baseline).

---

## Resource Tuning

Total CPU = `--jobs` × `--threads` (default: 16 × 2 = 32 cores).
Adjust to your hardware:

```bash
# 64-core machine: 16 jobs × 4 threads
msi-calc -r ref.fa -p pairs.csv -j 16 -t 4
```

Press Ctrl+C at any time to gracefully stop; in-progress jobs are killed and
partial outputs are cleaned up. Re-run to resume.

---

## Reference Scanning

On first run, msi-calc automatically scans the reference FASTA to generate a
microsatellite loci list (`<output>/microsatellites.list`) using:

```
msisensor-pro scan -d <ref.fa> -o <output>/microsatellites.list
```

The file is cached; subsequent runs skip the scan step automatically.
